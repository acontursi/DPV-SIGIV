<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        
    <title>DPV SIGIV | Sistema de Información Geográfica Integral Vial</title>

        <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>

    <link rel="stylesheet" href="style.css"> 

        
    <style>

body {
    padding: 0;
    margin: 0;
}
html, body, #map {
    height: 100%;
}

.legend {
    padding: 6px 8px;
    font: 14px Arial, Helvetica, sans-serif;
    background: white;
    background: rgba(255, 255, 255, 0.8);
    /*box-shadow: 0 0 100px rgba(0, 0, 0, 0.2);*/
    border-radius: 10px;
    border:1px solid black;
    line-height: 20px;
    color: black;
}
.legend h4 {
    text-align: left;
    font-size: 16px;
    margin: 2px 40px 8px;
    color: black;
}
.legend span {
    position: relative;
    bottom: 3px;
}
.legend i {
    width: 20px;
    height: 5px;
    float: left;
    margin: 0 8px 0 0;
    opacity: 0.7;
    border:2px solid black;
}
.box{
    position: absolute;
    top: 10%;
    z-index: 520;
    text-align: center;
    width: 300px;
    height: 120px;
    left: 75%;
    margin-left: -75px; /*----- half of the width*/ 
    border: 1px solid black;
    background-color: rgb(230, 218, 62);
}

#contenedor {
    text-align: left;
    width: 100%;
    height: 100%;
    margin: auto;
}
#map {
    width: 60%;
    float:left;
}
#dashboard {
    width: 40%;
    float:right;
}
#titulo1 {
    text-align: center;
    width: 100%;
    height: 0%;
    margin-left: 1%;
    margin-top: 1%;
    margin-bottom:0%
}
.clearfix:after {
 content: "";
 display: table;
 clear: both;
}

/*estilo gráfico de dona*/
.chartBox2 {  
    height: 400px;
    width: 50px;
    border-radius: 10px;
    border: solid 1px rgb(180, 135, 10);
    background-color: rgba(255, 255, 255, 0.596);
    margin-left: 25%;
    margin-top: 0%;
    margin-bottom:0%
}
/*estilo gráfico de barras*/
.chartBox {                        
    width: 450px;
    height: 225px;
    padding: 5px;
    border-radius: 10px;
    border: solid 1px rgb(180, 135, 10);
    background: white;
    margin: auto;
    margin-top: 0%;
    margin-bottom:0%
}
.sidebar{
    width: 15%;
    flex: 25%;
    /*background: #ccc;*/
    margin-top: 0%;
    margin-left: 8%;
    margin-bottom:0% 
}
.column {
    flex: 75%
}
#pie_pagina {
    text-align: center;
    width: 100%;
    height: 0%;
    margin-top: 0%;
    margin-bottom:0%
}

    </style>
    </head>

<body>
    <!-- CONTENEDOR -->
    <div id="contenedor" class="clearfix">

        <div id="map"></div>

        <div id="dashboard">
            <div id="titulo1">
            <p  >
                <FONT SIZE=3> <b>SIGIV</b></FONT> <FONT SIZE=3> <b>D.P.V. SANTA FE</b></FONT> 
            </div>           
            
            <!-- contenedores de gráficos-->
            
                    <div class="chartBox2" style="position: relative; height: 10%; width:52%">
                        <canvas id= "myChart2" style="position: center;"></canvas>
                    </div>
                
                <canvas id="barras_zonas" width="100" height="50" style="margin-top: -110px;"></canvas>
                <!--<div class="chartCard">-->
                        <div class="sidebar">
                            <select onchange="cambiozona(this)">                       
                                <option value="z1">Zona 1</option>                             
                                <option value="z2">Zona 2</option>
                                <option value="z3">Zona 3</option>
                                <option value="z4">Zona 4</option>
                                <option value="z5">Zona 5</option>
                                <option value="z6">Zona 6</option>
                                <option value="z7">Zona 7</option>
                                <option value="z8">Zona 8</option>
                                <option value="z9">Zona 9</option>
                                <option value="z10">Zona 10</option>
                            </select>
                        </div>
                        <div class="column">
                            <div class="chartBox">
                                <canvas id="myChart" ></canvas>
                            </div>
                        </div>
            <div id="pie_pagina">
                <p> <FONT SIZE=1> Dirección General de Programación - Área Sistemas de Información Geográfica </FONT> </p>
            </div>       
        </div>

    </div>

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src=" https://unpkg.com/leaflet@1.9.3/dist/leaflet.js "></script>
    <link rel="stylesheet" href=" https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <script src="https://code.jquery.com/jquery-3.2.1.js" ></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script> <!-- para trabajar con fechas-->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.1/chart.min.js"></script> -->
    <script>

const datos_kmcalzada = [                               
    {
        calzada: 'Pavimentada', zonax: {z1:212.646, z2:370.098, z3:630.505, z4:388.665 , z5:494.898, z6:892.468 , z7:373.927 , z8:176.989 , z9:164.83 , z10:511.632}
    },
    {
        calzada: 'Mejorada', zonax: {z1: 11.98, z2: 209.618, z3:317.615, z4:106.509 , z5:70.19 , z6:84.108 , z7:18.874 , z8:39.62 , z9:27.899 , z10:50.789}
    },
    {
        calzada: 'Natural', zonax: {z1: 534.648, z2: 988.241, z3:519.772, z4:672.867 , z5:725.431 , z6:1080.43 , z7:916.134 , z8:1224.73 , z9:1193.98 , z10:211.584}
    },
]
const data = {
        //labels: ['Pavimentada', 'Mejorada', 'Natural'],
        //labels: labels,    
        datasets: [{
            //label: 'Kms. de calzada por zona',
            //data: [50, 12, 6, 9, 12, 3, 9],
            data: datos_kmcalzada,
            barThickness: 75,
            borderSkipped: "bottom",
            borderRadius: 10,
            backgroundColor: [
                '#ff0127',
                '#db6adb',
                '#ffffff'
            ],
            borderColor: [
                'black',
                'black',
                'black',
            ],
            borderWidth: 1
        }]
    };

    // config 
    const config = {
        type: 'bar',
        data,             // tambien funciona como:  data:data,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false,
                    position: 'top'
                },
                title: {
                    display: true,
                    text: 'Total de km. por tipo de calzada según zona'
                }
            },
            interaction: {
                intersect: true,
            },
            scales: {
                y: {
                    min: 0,
                    max: 1300,
                    beginAtZero: true
                }
            },
            hoverBackgroundColor: [
                "#eacc07"
            ]
        }
    };
          
    // render init block
    const myChart = new Chart(
        document.getElementById('myChart'),
        config
        );
        
        function cambiozona(option) {
            console.log(option.value);
            const tipoCalzada = option.value;
            const zonaData = datos_kmcalzada.map((item) => {      // Buscamos los datos de todas las zonas para el tipo de calzada seleccionado
                const valorZona = item.zonax[tipoCalzada];
                return { x: item.calzada, y: valorZona !== undefined ? valorZona : 0 };
            });
            if (zonaData.every(data => data.y !== undefined)) {   // Aca vemos si se encontraron datos para el tipo de calzada
                myChart.data.datasets[0].data = zonaData;         // Aca se actualziza el gráfico con los datos de todas las zonas
            }
            myChart.update();
        }


/////////////////////////////////////////////////////////////
////////////DATOS DE TOTALES para gráficos///////////////////               /////estos datos son erroneos!!!!!!/////
/////////////////////////////////////////////////////////////
    // setup 
    const data2 = {
        labels: ['Pavimentada (30%)', 'Natural (60%)', 'Mejorada (10%)'],
        datasets: [{                 
            data: [4216.658, 8067.817, 937.202], 
            hoverBackgroundColor: '#eacc07',
            backgroundColor: [
                '#ff0127',
                '#ffffff',
                '#db6adb'
            ],
            borderColor: [
                'black',
                'black',
                'black',
            ],
            borderWidth: 2,
            hoverOffset: 4,
        }]
    };

/////////////////////////////////////////////////////////////
////////////TOTALES GENERALES x calzada (dona)///////////////
/////////////////////////////////////////////////////////////
    // config 
    const config_dona = {
        type: 'doughnut',
        data: data2,
        options: {
            plugins:{
                title: {
                    display: true,
                    text: 'Total de km. por tipo de calzada'
                },
                legend: {
                    display: true,
                    position: 'right',
                    fullSize: true,
                    labels:{
                        padding: 4,
                        boxHeight: 5,
                        boxWidth: 25
                    },
                },
            },
            interaction: {
                intersect: true,
            },
            responsive: true
        }
    };
    // render init block
    const myChart2 = new Chart(
        document.getElementById('myChart2'),
        config_dona
        );

//////////////////////////////////////////////////////////////////////////
////////////////////////////   VARIABLES   //////////////////////////////
////////////////////////////////////////////////////////////////////////
    var visor               // Visor
    var mapas_base          // Mapas Base
    var mb_carto            // Mapa Base de CARTO
    var mb_esri_satelite    // Mapa Base Satelital de ESRI
    var mb_ign_argenmap     // Mapa Base IGN
    var mb_ign_topografico  // Mapa Base Topográfico de IGN
    var redvial
    var calzada             // Calzadas
    var zonas

//////////////////////////////////////////////////////////////////////////
////////////////////////////   MAPAS BASE   /////////////////////////////
////////////////////////////////////////////////////////////////////////    

// Mapa Base CARTO
var mb_carto = L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'DPV Santa Fe - Área de SIG | © CARTO'
});
  
// Mapa Base ESRI Satelite
var mb_esri_satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: '© ESRI Imagery/Satellite'
});

// Mapas Base IGN
var mb_ign_argenmap = L.tileLayer('https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/capabaseargenmap@EPSG%3A3857@png/{z}/{x}/{-y}.png', {
    maxZoom: 19,
    attribution: '<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | <a href="http://www.ign.gob.ar/AreaServicios/Argenmap/IntroduccionV2" target="_blank">Instituto Geográfico Nacional</a> + <a href="http://www.osm.org/copyright" target="_blank">OpenStreetMap</a>'
});

var mb_ign_topografico = L.tileLayer('https://wms.ign.gob.ar/geoserver/gwc/service/tms/1.0.0/mapabase_topo@EPSG%3A3857@png/{z}/{x}/{-y}.png', {
    maxZoom: 19,
    attribution: '<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | <a href="http://www.ign.gob.ar/AreaServicios/Argenmap/IntroduccionV2" target="_blank">Instituto Geográfico Nacional</a> + <a href="http://www.osm.org/copyright" target="_blank">OpenStreetMap</a>'
});   

// Mapas Base
var mapas_base = {
   "CARTO": mb_carto,
   "ESRI: Satellite": mb_esri_satelite,
   "IGN: Argenmap": mb_ign_argenmap,
   "IGN: Topográfico": mb_ign_topografico
};

//  MAPA CENTRADO EN SANTA FE
var visor = L.map('map',{
    zoomSnap: 0.1,
    layers: [mb_carto],
    renderer: L.canvas({ tolerance: 50 })    //---> propiedad que amplia el radio de selección con el mouse para todas las capas
}).setView([-31.25, -61], 6.9);

/*var canvasRenderer = L.canvas({padding: 5, tolerance: 50});*/  //---> variable que amplia el radio de selección con el mouse para la capa que llame esta "var"

var layerControl = L.control.layers(mapas_base).addTo(visor);

// ESCALA
L.control.scale({
    metric: true, imperial: false,
    position: 'bottomright'
}).addTo(visor);


//////////////////////////////////////////////////////////////////////////////// 
////////////////////////////   DPV - Zonas WMS   //////////////////////////////
//////////////////////////////////////////////////////////////////////////////

 var wmszonas = L.tileLayer.wms('http://10.7.20.214:8080/geoserver/sigiv/wms?', {
    layers: 'zonas',
    format: 'image/png',
	transparent: true,
	version: '1.3.0'
	}).addTo(visor); 

////////////////////////////////////////////////////////////////////////////////////// 
////////////////////////////   DPV - Departamentos WMS   ////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

var wmsdepartamentos = L.tileLayer.wms('http://10.7.20.214:8080/geoserver/sigiv/wms?', {
    layers: 'departamentos',
    format: 'image/png',
	transparent: true,
	version: '1.3.0'
	}).addTo(visor);

//////////////////////////////////////////////////////////////////////////////////// 
////////////////////////////   DPV - Distritos WMS   //////////////////////////////
//////////////////////////////////////////////////////////////////////////////////

var wmsdistritos = L.tileLayer.wms('http://10.7.20.214:8080/geoserver/sigiv/wms?', {
    layers: 'distritos',
    format: 'image/png',
	transparent: true,
	version: '1.3.0'
	}).addTo(visor);

////////////////////////////////////////////////////////////////////// 
///////////////   DPV - Localidades y Parajes WMS   /////////////////
////////////////////////////////////////////////////////////////////

var wmslocalidades_parajes = L.tileLayer.wms('http://10.7.20.214:8080/geoserver/sigiv/wms?', {
    layers: 'localidades_parajes',
    format: 'image/png',
	transparent: true,
	version: '1.3.0'
	}).addTo(visor);




// ZONAS
var zonas = 'http://10.7.20.214:8080/geoserver/dpv_sigiv/wfs?';
    var defaultParameters = {
        service: 'WFS',
        version: '2.0.0',
        request: 'GetFeature',
        typeName: 'dpv_sigiv:zonas',
        srsname: 'EPSG:4326',
        outputFormat: 'application/json',
    };
    var parameters = L.Util.extend(defaultParameters);
    var URL = zonas + L.Util.getParamString(parameters);

var style_zonas = /*{
    fillColor: "orange",    ///---> relleno color
    color: "black",          ///---> borde color
    weight: 0.5, 				///---> borde ancho
    opacity: 1,             ///---> borde opacidad
    fillOpacity: 0.1          ///---> relleno opacidad
};*/ ///---> Un solo estilo par la capa (poniendo en "style" de la capa: style: (style_zonas), onEachFeature....)

// INICIO Llamada AJAX
$.ajax({
	url: URL,
	success: function (data) {		
			var zonas = new L.geoJson(data, {
                style: function (feature) {
            var z;
            switch (feature.properties.zona) {
                case 'RECONQUISTA': c = 'grey'; break;
                case 'SAN CRISTOBAL': c = 'blue'; break;
                case 'RAFAELA': c = 'green'; break;
                case 'SAN JAVIER': c = 'brown'; break;
                case 'TOSTADO': c = 'pink'; break;
                case 'EL TREBOL': c = 'orange'; break;
                case 'ROSARIO': c = 'lightblue'; break;
                case 'VENADO TUERTO': c = 'yellow'; break;
                case 'VERA': c = 'purple'; break;
                case 'LA CAPITAL': c = 'black'; break;
                default: c = '#000000';
            }
            return {color: c, opacity: 1, weight: 0.5};
        },
        onEachFeature: function(feature, layer) {
        },
        pane: "zonasPane"
    }).bindPopup(function (layer) {
        return (`<b> Zona: </b>` + layer.feature.properties.zona + 
                `<b></br> N°: </b>` + layer.feature.properties.dpv_zona			   ///---> Si pondría esto: '</br>' +  antes del 'iddpv' me genera un espacio vacío arriba del titulo del PopUp
    	)
    }).addTo(visor).bringToBack();
layerControl.addOverlay(zonas, "Zonas");
				 						
/////////////////////////
///// CIERRE LLAMADA AJAX
			}
		});

// DEPARTAMENTOS
var departamentos = 'http://10.7.20.214:8080/geoserver/dpv_sigiv/wfs?';
    var defaultParameters = {
        service: 'WFS',
        version: '2.0.0',
        request: 'GetFeature',
        typeName: 'dpv_sigiv:dptos',
        srsname: 'EPSG:4326',
        outputFormat: 'application/json',
    };
    var parameters = L.Util.extend(defaultParameters);
    var URL = zonas + L.Util.getParamString(parameters);

// INICIO Llamada AJAX
$.ajax({
	url: URL,
	success: function (data) {		
			var departamentos = new L.geoJson(data, {
                style: function (feature) {
                    var z;
                    switch (feature.properties.dpto) {
                        case '9 de Julio': z = 'brown'; break;
                        case 'Belgrano': z = 'lightblue'; break;
                        case 'Caseros': z = 'green'; break;
                        case 'Castellanos': z = 'purple'; break;
                        case 'Constitución': z = 'yellow'; break;
                        case 'Garay': z = 'pink'; break;
                        case 'General Lopez': z = 'grey'; break;
                        case 'General Obligado': z = 'blue'; break;
                        case 'Iriondo': z = 'brown'; break;
                        case 'La Capital': z = 'black'; break;
                        case 'Las Colonias': z = 'lightblue'; break;
                        case 'Rosario': z = 'black'; break;
                        case 'San Cristobal': z = 'green'; break;
                        case 'San Javier': z = 'red'; break;
                        case 'San Jerónimo': z = 'blue'; break;
                        case 'San Justo': z = 'orange'; break;
                        case 'San Lorenzo': z = 'lightblue'; break;
                        case 'San Martin': z = 'red'; break;
                        case 'Vera': z = 'yellow'; break;
                        default: z = '#000000';
                    }
                    return {color: z, opacity: 0.1, fillOpacity: 0.1, weight: 1};
                },
				onEachFeature: function(feature, layer) {
                },
                pane: "departamentoPane"
			}).bindPopup(function (layer) {
    				return (`<b> Dpto.: </b>` + layer.feature.properties.dpto
                    )    
			}).addTo(visor).bringToBack();
			layerControl.addOverlay(departamentos, "Departamentos");
				 						
/////////////////////////
///// CIERRE LLAMADA AJAX
			}
		});


/////////////////////////
//////LEGEND Rutas
var legend = L.control({ position: "bottomleft" });
legend.onAdd = function(visor) {
  var div = L.DomUtil.create("div", "legend");
  div.innerHTML += "<h4>Red Vial</h4>";
  div.innerHTML += '<i style="background: #FF0127"></i><span>Pavimentada</span><br>';
  div.innerHTML += '<i style="background: #DB6ADB"></i><span>Mejorada</span><br>';
  div.innerHTML += '<i style="background: #ffffff"></i><span>Natural</span><br>';
  return div;
};
legend.addTo(visor);

</script>

</body>
</html>
